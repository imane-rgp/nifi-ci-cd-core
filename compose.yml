volumes:
  nifi_registry_database:
  nifi_registry_flow_storage:
  nifi_database_repository:
  nifi_flowfile_repository:
  nifi_content_repository:
  nifi_provenance_repository:
  nifi_nar_extensions:
  nifi_python_extensions:
  nifi_conf:
  nifi_state:
  nifi_logs:

networks:
  nifi_network:
    driver: bridge

services:

  nifi-registry:
    image: apache/nifi-registry:2.6.0
    container_name: nifi-registry
    user: root
    ports:
      - "18080:18080"
    environment:
      - NIFI_REGISTRY_WEB_HTTP_PORT=18080
      - NIFI_REGISTRY_WEB_HTTP_HOST=0.0.0.0
    volumes:
      - nifi_registry_database:/opt/nifi-registry/nifi-registry-current/database
      - nifi_registry_flow_storage:/opt/nifi-registry/nifi-registry-current/flow_storage
    networks:
      - nifi_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18080/nifi-registry"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
 
  nifi:
    image: apache/nifi:2.6.0
    container_name: nifi
    user: root
    ports:
      - "8443:8443"
    environment:
      - SINGLE_USER_CREDENTIALS_USERNAME=$NIFI_USERNAME
      - SINGLE_USER_CREDENTIALS_PASSWORD=$NIFI_PASSWORD
      - NIFI_WEB_HTTPS_PORT=8443
      - NIFI_WEB_HTTPS_HOST=0.0.0.0
      - NIFI_WEB_PROXY_HOST=localhost:8443
      - NIFI_CLUSTER_IS_NODE=false
      - NIFI_ZK_CONNECT_STRING=
      - NIFI_ELECTION_MAX_WAIT=1 min
    mem_limit: 4g
    volumes:
      - nifi_conf:/opt/nifi/nifi-current/conf
      - nifi_database_repository:/opt/nifi/nifi-current/database_repository
      - nifi_flowfile_repository:/opt/nifi/nifi-current/flowfile_repository
      - nifi_content_repository:/opt/nifi/nifi-current/content_repository
      - nifi_provenance_repository:/opt/nifi/nifi-current/provenance_repository
      - nifi_nar_extensions:/opt/nifi/nifi-current/nar_extensions
      - nifi_python_extensions:/opt/nifi/nifi-current/python_extensions
      - nifi_state:/opt/nifi/nifi-current/state
      - nifi_logs:/opt/nifi/nifi-current/logs
      - ./extensions:/opt/nifi/nifi-current/extensions
    networks:
      - nifi_network
    depends_on:
      nifi-registry:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost:8443/nifi"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s